<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coffee Master List</title>
<style>
:root{--bg:#0b0c0e;--panel:#111318;--muted:#a0a6b3;--fg:#e7ebf3;--accent:#86e1a0;--chip:#1a1d25;--chipb:#262a35;--overlay:rgba(0,0,0,.55)}
body{font-family:Inter,Segoe UI,system-ui,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:24px}
.wrap{max-width:1200px;margin:0 auto}
.header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
.title{font-weight:700;letter-spacing:.2px;margin:0;font-size:22px}
.muted{color:var(--muted)}
.panel{background:var(--panel);border:1px solid #222532;border-radius:16px;padding:14px 16px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
.controls{display:grid;grid-template-columns:1fr 200px 160px 160px;gap:10px;align-items:center;margin-bottom:16px}
input[type=search],select{background:#0f1116;border:1px solid #2a2f3b;color:var(--fg);border-radius:12px;padding:10px 12px;outline:none}
input[type=search]::placeholder{color:#7d8493}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.card{background:var(--panel);border:1px solid #202534;border-radius:18px;padding:14px;display:flex;flex-direction:column;gap:8px;transition:transform .08s ease, border-color .2s ease}
.card:hover{transform:translateY(-2px);border-color:#2d3446}
.row{display:flex;justify-content:space-between;gap:10px;align-items:center}
.chip{background:var(--chip);border:1px solid var(--chipb);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
.ok{color:#9be8ae;border-color:#35543d;background:#112017}.no{color:#ffb3b3;border-color:#5a2f2f;background:#201113}
a{color:var(--fg);text-decoration:none}a:hover{color:var(--accent)}
.small{font-size:12px;color:var(--muted)}
.modal-backdrop{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{width:min(640px,92vw);background:var(--panel);border:1px solid #2d3446;border-radius:18px;box-shadow:0 30px 60px rgba(0,0,0,.45);padding:16px 16px 12px}
.modal h2{margin:2px 0 6px 0;font-size:18px}
.modal .meta{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px 0}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.btn{background:#141825;border:1px solid #2d3446;border-radius:12px;color:var(--fg);padding:10px 12px;cursor:pointer}
.btn.primary{background:#1e2a22;border-color:#3d6b4c}
.btn:hover{filter:brightness(1.1)}
</style>

<div class="wrap">
  <div class="header">
    <h1 class="title">Coffee Master List</h1>
    <div class="muted small" id="stamp">Loading…</div>
  </div>

  <!-- New drops banner (shown only if ?ids=... or multiple ids present) -->
  <div id="newBanner" class="panel" style="display:none; margin-bottom:12px">
    <div class="row" style="align-items:center">
      <div><strong id="newCount">New drops</strong></div>
      <div id="newChips" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>
  </div>

  <div class="panel controls">
    <input id="q" type="search" placeholder="Search title / notes / price…" />
    <select id="roaster"><option value="">All roasters</option></select>
    <select id="country"><option value="">All countries</option></select>
    <select id="stock"><option value="">Any status</option><option value="in">In stock</option><option value="out">Sold out</option></select>
  </div>

  <div id="grid" class="grid"></div>
</div>

<!-- Modal -->
<div id="backdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="row">
      <h2 id="m_title"></h2>
      <span class="chip" id="m_roaster"></span>
    </div>
    <div class="meta">
      <span class="chip" id="m_price"></span>
      <span class="chip" id="m_country"></span>
      <span class="chip" id="m_process"></span>
      <span class="chip" id="m_profile"></span>
    </div>
    <div class="small muted" id="m_notes"></div>
    <div class="row small" style="margin-top:10px">
      <div>First: <span id="m_first"></span></div>
      <div>Last: <span id="m_last"></span></div>
    </div>
    <div class="actions">
      <button id="m_prev" class="btn">◀ Prev</button>
      <a id="m_link" class="btn primary" target="_blank" rel="noopener">Visit product</a>
      <button id="m_next" class="btn">Next ▶</button>
      <button id="m_close" class="btn">Close</button>
    </div>
  </div>
</div>

<script type="module">
  // ---- FIREBASE_CONFIG: paste your real config here ----
  const firebaseConfig = {
    apiKey: "AIzaSyB7ovDN0lvwYZ872cFCxF_yI8BAFbm6xpw",
    authDomain: "coffee-drop-monitor.firebaseapp.com",
    projectId: "coffee-drop-monitor",
    storageBucket: "coffee-drop-monitor.firebasestorage.app",
    messagingSenderId: "578440481584",
    appId: "1:578440481584:web:97463ed94ebc3f976696f5",
    measurementId: "G-76KG6PQLNF"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  const qEl = document.getElementById('q');
  const roEl = document.getElementById('roaster');
  const coEl = document.getElementById('country');
  const stEl = document.getElementById('stock');
  const grid = document.getElementById('grid');
  const stamp = document.getElementById('stamp');

  const newBanner = document.getElementById('newBanner');
  const newCount  = document.getElementById('newCount');
  const newChips  = document.getElementById('newChips');

  const backdrop = document.getElementById('backdrop');
  const mTitle = document.getElementById('m_title');
  const mRoaster = document.getElementById('m_roaster');
  const mPrice = document.getElementById('m_price');
  const mCountry = document.getElementById('m_country');
  const mProcess = document.getElementById('m_process');
  const mProfile = document.getElementById('m_profile');
  const mNotes = document.getElementById('m_notes');
  const mFirst = document.getElementById('m_first');
  const mLast = document.getElementById('m_last');
  const mLink = document.getElementById('m_link');
  const mClose = document.getElementById('m_close');
  const mPrev = document.getElementById('m_prev');
  const mNext = document.getElementById('m_next');

  let ITEMS = [];
  let CARDS = [];
  let NEW_IDS = [];            // ids provided via ?ids=...
  let CURRENT_NEW_INDEX = -1;  // pointer within NEW_IDS

  function byId(id){ return ITEMS.find(x=>x.id===id); }

  function openModal(item){
    if(!item) return;
    mTitle.textContent = item.title;
    mRoaster.textContent = item.roaster;
    mPrice.textContent = item.price || '';
    mCountry.textContent = item.country || '';
    mProcess.textContent = item.process || '';
    mProfile.textContent = item.profile || '';
    mNotes.textContent = item.notes || '';
    mFirst.textContent = item.first_seen || '';
    mLast.textContent = item.last_seen || '';
    mLink.href = item.url;
    backdrop.style.display='flex';
    history.replaceState(null,'',`?id=${item.id}` + (NEW_IDS.length ? `&ids=${NEW_IDS.join(',')}` : ''));
    updatePrevNext(item.id);
  }

  function closeModal(){ backdrop.style.display='none'; }

  function updatePrevNext(currentId){
    if (!NEW_IDS.length){
      mPrev.style.display = 'none';
      mNext.style.display = 'none';
      return;
    }
    mPrev.style.display = '';
    mNext.style.display = '';
    CURRENT_NEW_INDEX = NEW_IDS.indexOf(currentId);
    mPrev.disabled = CURRENT_NEW_INDEX <= 0;
    mNext.disabled = CURRENT_NEW_INDEX === -1 || CURRENT_NEW_INDEX >= NEW_IDS.length - 1;
  }

  function jumpToId(id){
    const it = byId(id);
    if (it){
      const el = CARDS.find(c=>c.dataset.id===id);
      if (el) el.scrollIntoView({behavior:'smooth', block:'center'});
      openModal(it);
    }
  }

  backdrop.addEventListener('click', e=>{ if(e.target===backdrop) closeModal(); });
  mClose.addEventListener('click', closeModal);
  mPrev.addEventListener('click', ()=>{
    if (CURRENT_NEW_INDEX > 0) jumpToId(NEW_IDS[CURRENT_NEW_INDEX - 1]);
  });
  mNext.addEventListener('click', ()=>{
    if (CURRENT_NEW_INDEX !== -1 && CURRENT_NEW_INDEX < NEW_IDS.length - 1)
      jumpToId(NEW_IDS[CURRENT_NEW_INDEX + 1]);
  });
  window.addEventListener('keydown', (e)=>{
    if (backdrop.style.display === 'flex'){
      if (e.key === 'ArrowLeft') mPrev.click();
      if (e.key === 'ArrowRight') mNext.click();
      if (e.key === 'Escape') mClose.click();
    }
  });

  function apply(){
    const qs=(qEl.value||'').toLowerCase();
    const rr=roEl.value; const cc=(coEl.value||'').toLowerCase(); const ss=stEl.value;
    for(const c of CARDS){
      const mText = c.dataset.title.includes(qs) || c.dataset.price.includes(qs) || c.dataset.notes.includes(qs);
      const mRo = !rr || c.dataset.roaster===rr;
      const mCo = !cc || c.dataset.country===cc;
      const mSt = !ss || c.dataset.stock===ss;
      c.style.display=(mText&&mRo&&mCo&&mSt)?'flex':'none';
    }
  }

  (async function init(){
    const snap = await getDocs(collection(db, 'coffees'));
    const items = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    ITEMS = items;

    const gen = new Date().toISOString().slice(0,16).replace('T',' ');
    stamp.textContent = `Loaded ${gen} • ${items.length} items`;

    // filters
    const roasters = [...new Set(items.map(x=>x.roaster))].sort();
    for(const r of roasters){ const o=document.createElement('option'); o.textContent=r; roEl.appendChild(o); }
    const countries = [...new Set(items.map(x=>x.country).filter(Boolean))].sort();
    for(const c of countries){ const o=document.createElement('option'); o.textContent=c; coEl.appendChild(o); }

    // cards
    const frag = document.createDocumentFragment();
    for(const it of items){
      const a = document.createElement('a');
      a.className='card';
      a.href = it.url; a.target='_blank'; a.rel='noopener';
      a.dataset.id = it.id;
      a.dataset.roaster = it.roaster || '';
      a.dataset.title   = (it.title||'').toLowerCase();
      a.dataset.price   = (it.price||'').toLowerCase();
      a.dataset.notes   = (it.notes||'').toLowerCase();
      a.dataset.country = (it.country||'').toLowerCase();
      a.dataset.stock   = it.in_stock? 'in':'out';
      a.innerHTML = `
        <div class='row'><div class='chip'>${esc(it.roaster||'')}</div><div class='chip ${it.in_stock?'ok':'no'}'>${it.in_stock?'In stock':'Sold out'}</div></div>
        <div style='font-weight:600'>${esc(it.title||'')}</div>
        <div class='muted'>${esc(it.price||'')}</div>
        <div class='row small'><div>First: ${esc(it.first_seen||'')}</div><div>Last: ${esc(it.last_seen||'')}</div></div>
      `;
      a.addEventListener('click', (e)=>{ e.preventDefault(); openModal(it); });
      frag.appendChild(a);
      CARDS.push(a);
    }
    grid.appendChild(frag);

    qEl.addEventListener('input', apply); roEl.addEventListener('change', apply); coEl.addEventListener('change', apply); stEl.addEventListener('change', apply);
    apply();

    // deep link(s)
    const params = new URLSearchParams(location.search);
    const idsParam = params.get('ids');
    const singleId = params.get('id');

    NEW_IDS = idsParam ? idsParam.split(',').filter(Boolean) : [];
    if (singleId && !NEW_IDS.includes(singleId)) {
      NEW_IDS.unshift(singleId);
    }

    // Show banner if multiple IDs
    if (NEW_IDS.length) {
      const found = NEW_IDS.map(id => byId(id)).filter(Boolean);
      if (found.length) {
        newCount.textContent = (found.length === 1)
          ? `1 new coffee`
          : `${found.length} new coffees`;
        newChips.innerHTML = '';
        for (const it of found) {
          const chip = document.createElement('button');
          chip.className = 'chip';
          chip.style.cursor = 'pointer';
          chip.title = it.title;
          chip.textContent = `${it.roaster} — ${it.title}`;
          chip.addEventListener('click', ()=> jumpToId(it.id));
          newChips.appendChild(chip);
        }
        newBanner.style.display = 'block';
      }
    }

    // Open first id if present, else just single id
    if (NEW_IDS.length) {
      jumpToId(NEW_IDS[0]);
    } else if (singleId) {
      const it = byId(singleId);
      if (it) {
        openModal(it);
        const el = CARDS.find(c=>c.dataset.id===singleId);
        if (el) el.scrollIntoView({behavior:'smooth',block:'center'});
      }
    }
  })();
</script>
